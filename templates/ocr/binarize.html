{% extends "standard.html" %}

{% block headerscript %}
	<script type='application/javascript' src='/static/js/jquery.cookie.js'></script>
	<script type='application/javascript' src='/static/js/ocr-line-views.js'></script>
    <link rel="stylesheet" href="/static/css/upload_results.css" type="text/css" media="screen" />

<style type="text/css">
    
    .binparams {
        padding: 5px;
    }

    .component_opts {
        /*display: none;*/
        font-size: 0.8em;
        margin-bottom: 20px;        
    }
    .component_opts label {
        float: left;
        width: 8em;
        text-align: right;
        padding-right: 5px;
        clear: left;
    }
    .component_opts input {
        float: left;
        width: 12em;
        height: 1em;
        border: 1px solid #999999;
        background-color: FFFFDD;
        text-align: right;
        padding-right: 5px;
        font-size: 0.9em;
    }
    /* HACK */
    .clear {
        clear: left;
    }


</style>
{% endblock %}

{% block content %}

<!-- code adapted from http://www.appelsiini.net/demo/html5_upload/demo.html -->
<script type="text/javascript" charset="utf-8">


$(function() {
    
    var XHRQUEUE = [];
    var BOUNDARY = '------multipartformboundary' + (new Date).getTime();
    var DASHDASH = '--';
    var CRLF     = '\r\n';
    var NUMFILES = 1;


    /* Display uploaded files. */
    //$("#dropzone").load("list.php");
    
    /* We cannot use $.bind() since jQuery does not normalize the native events. */
    $('#dropzone')
        .get(0)
        .addEventListener('drop', upload, false);
    $('#dropzone')
        .get(0)
        .addEventListener('dragenter', function(event) { 
                $('#dropzone').css("background-color", "#ffc"); 
            }, false);
    $('#dropzone')
        .get(0)
        .addEventListener('dragexit', function(event) { 
                $('#dropzone').css("background-color", "#fff"); 
            }, false);
    $('#dropzone')
        .get(0)
        .addEventListener('dragover', function(event) { 
                event.preventDefault(); 
            }, false);

    $(".ocr_line").live("click", function(e) {
            //alert("clicked!");
    });

    $("#singleupload").change(function(event) {
        if ($(this).val() == "") {
            return false;
        }
        $("#uploadform").submit();
    });

    $("#uploadform").submit(function(event) {
        return AIM.submit(this, {
            'onStart' : function(e) {
                // make something useful before submit (onStart)
                $("#dropzone").text("Please wait...").addClass("waiting");
                $("#pageout").html("");
         		return true;
            },                                     
            'onComplete' : onXHRLoad,
        });
    });


    $(".view_link").live("click", function(e) {
        var divid = $(this).parent().attr("id").replace(/_head$/, "");
        if ($(this).text() == "View Layout") {
            positionByBounds($("#" + divid));
            $(this).text("View Paragraphs");
        } else {
            $("#" + divid).attr("style", "");
            insertBreaks($("#" + divid));
            $(this).text("View Layout");
        }
        return false;            
    });


    function pollForResults(element) {
        var jobname = element.data("jobname");
        $.getJSON(
            "/ocr/results/" + jobname,
            function (data) {
                if (data.error) {
                    element
                        .removeClass("waiting")                
                        .addClass("error")
                        .html("<h4>Error: " + data.error + "</h4>")
                        .append(
                            $("<div></div>").addClass("traceback")
                                .append("<pre>" + data.trace + "</pre>")                                
                        );                            
                } else if (data.status == "SUCCESS") {
                    var srcimg = $("<img></img>")
                        .attr("src", "/imageops/scale?image="+ data.results.src + "&w=" + element.width()
                            + "&t=" + (new Date).getTime())
                        .addClass("binsrc")
                        .css("display", "none");
                    var dstimg = $("<img></img>")
                        .attr("src", "/imageops/scale?image="+ data.results.dst + "&w=" + element.width()
                            + "&t=" + (new Date).getTime())
                        .addClass("bindst");                        
                    element.append(srcimg);
                    element.append(dstimg);                        
                    element.removeClass("waiting");
                    NUMFILES--;                    
                } else if (data.status == "PENDING") {
                    setTimeout(function() {
                        pollForResults(element);
                        }, 500 * NUMFILES);
                } else {
                    element.html("<p>Oops, task finished with status: " + data.status + "</p>");
                }
            }
        ); 
    }


    function onXHRLoad(event_or_response) {
        var data;
        if (typeof(event_or_response) != "string") {
            var xhr = event_or_response.target;
            if (!xhr.responseText) {
                return;
            }                
            if (xhr.status != 200) {
                return alert("Error: " + xhr.responseText + "  Status: " + xhr.status);
            } 
            data = $.parseJSON(xhr.responseText);
        } else {
            // then it must be a single upload...
            data = $.parseJSON(event_or_response);
            $("#singleupload").val("");
            
        }

        if (data.error) {
            alert("Error: " + data.error + "\n\n" + data.trace);
            $("#dropzone").text("Drop images here...").removeClass("waiting");
            return;
        }

        $("#togglesrc").click(function(e) {
            $(".binsrc").toggle();
            $(".bindst").toggle();    
        });

        $.each(data, function(page, pageresults) {
            var pagename = pageresults.job_name.split("::")[0].replace(/\.[^\.]+$/, "");
            var phead = $("<div></div>")
                .addClass("ocr_page_head")
                .attr("id", "ocr_page_" + pagename + "_head")
                .text(pagename)
                .append($("<a></a>").attr("href", "#").addClass("view_link").text("View Layout"))                
                .append(
                    $("<a></a>").attr("href", "/ocr/results/" + pageresults.job_name + "?format=text")
                        .attr("target", "_blank")
                        .addClass("result_link")
                        .text("Text")
                )                
                .append(
                    $("<a></a>").attr("href", "/ocr/results/" + pageresults.job_name + "?format=json")
                        .attr("target", "_blank")
                        .addClass("result_link")
                        .text("Json")
                );                
            $("#pageout").append(phead); 
            var pdiv = $("<div></div>")
                .addClass("ocr_page")
                .addClass("waiting")
                .attr("id", "ocr_page_" + pagename)
                .data("jobname", pageresults.job_name);
            $("#pageout").append(pdiv);
            pollForResults(pdiv);
        }); 
        if (XHRQUEUE.length) {
            var fxhr = XHRQUEUE.shift();
            fxhr.open("POST", "/ocr/binarize?nohang=1", true);
            fxhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");
            fxhr.setRequestHeader('content-type', 'multipart/form-data; boundary=' + BOUNDARY); 
            fxhr.sendAsBinary(fxhr.builder);
        } else {
            $("#dropzone").text("Drop images here...").removeClass("waiting"); 
        }
    };


    function upload(event) {
        
        var data = event.dataTransfer;
        for (var i = 0; i < data.files.length; i++) {
            if (data.files[i].type.search("image/") == -1) {
                alert("Error: invalid file type: " + data.files[i].type);
                event.stopPropagation();
                return;
            }
        }

        // set the global NUMFILES variable
        NUMFILES = data.files.length;
  
        /* Show spinner for each dropped file and say we're busy. */
        $("#dropzone").text("Please wait...").addClass("waiting");
        $("#pageout").html("");

        var textparams = {
            engine: $("input[@name=engine]:checked").val(),
            pseg: $("#form_segmenter").val(),
            cmodel: $("#form_cmodel").val(),
            lmodel: $("#form_lmodel").val()   
        }
        
        for (var i = 0; i < data.files.length; i++) {
            var file = data.files[i];
            var binaryReader = new FileReader();    
            /* Build RFC2388 string. */
            var builder = '';
            builder += DASHDASH;
            builder += BOUNDARY;
            builder += CRLF;

            /* append text param values */
            $.each(textparams, function(key, value) {
                builder += 'Content-Disposition: form-data; name="' + key + '"; ';
                builder += 'Content-Type: text/plain';
                builder += CRLF;
                builder += CRLF;
                builder += value;
                builder += CRLF;
                builder += DASHDASH;
                builder += BOUNDARY;
                builder += CRLF;
            });
            
            /* Generate headers. */            
            builder += 'Content-Disposition: form-data; ';
            builder += 'name="userfile' + i + '[]"';
            if (file.fileName) {
              builder += '; filename="' + file.fileName + '"';
            }
            builder += CRLF;
 
            builder += 'Content-Type: ' + file.type;
            builder += CRLF;
            builder += CRLF; 
 
            /* Append binary data. */
            builder += file.getAsBinary() ;//binaryReader.readAsBinaryString(file);
            builder += CRLF;
 
            /* Write BOUNDARY. */
            builder += DASHDASH;
            builder += BOUNDARY;
            builder += CRLF;
        
            /* Mark end of the request. */
            builder += DASHDASH;
            builder += BOUNDARY;
            builder += DASHDASH;
            builder += CRLF;
            try {
                var xhr = new XMLHttpRequest();
                xhr.builder = builder;
                xhr.onload = onXHRLoad;
                XHRQUEUE.push(xhr);
            } catch (e) {
                alert(e);
                alert('multipart/form-data; boundary=' + BOUNDARY)
            }
        }
        if (XHRQUEUE.length) {
            var fxhr = XHRQUEUE.shift();
            fxhr.open("POST", "/ocr/binarize", true);
            fxhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");
            fxhr.setRequestHeader('content-type', 'multipart/form-data; boundary=' + BOUNDARY); 
            fxhr.sendAsBinary(fxhr.builder);
        }

        /* Prevent FireFox opening the dragged file. */
        event.stopPropagation();
        
    }


    buildComponentOptions();

    //rebuildModelLists($("input[name=engine]:checked").val());     
});

var PARAMDATA = [];
var done = false;
function buildComponentParams(type, current) {
    $("#" + type + "_opts").html("");
    var paraminput = $("<input />")
        .attr("type", "text")
        .addClass("binopt");    
    $.each($(".bincomp[name='" + type + "']"), function(index, selectitem) {
        $.each(PARAMDATA, function(index, component) {
            if (component.name == current) {
                var optbox = $("#" + component.type + "_opts");
                $.each(component.params, function(index, param) {
                    optbox
                        .append(
                            $("<label>" + param.name + "</label>")
                                .attr("for", type + "_" + param.name)
                        )
                        .append(
                            paraminput.clone()
                                .attr("id", type + "_" + param.name)
                                .attr("name", param.name)
                                .attr("value", param.value)
                    );
                });                
            }
        });
        $("#" + type + "_opts").append($("<div class='clear'></div>"));
    });
}

// munge the 'component type' of the 'StandardPreprocessing'
// component so that it says "Preprocess" instead of "IBinarize".
// This allows us to put it in its own section where is it more
// useful
function mungePreprocessComponent(data) {
    for (var i = 0; i < data.length; i++) {
        if (data[i].name == "StandardPreprocessing") {
            data[i].type = "Preprocess";
            break;
        }
    }
    return data;
}


function buildComponentOptions() {
    var opt = $("<option></option>").addClass("binopt");
    var types = [];
    $.map($(".bincomp"), function(n, i) {
        types.push("type=" + $(n).attr("name"));
        });
    // returns a list component hashes
    $.getJSON("/ocr/components", types.join("&"), function(dlist) {
        PARAMDATA = mungePreprocessComponent(dlist);
        var optdict = {};
        $.each(PARAMDATA, function(index, component) {
            var selector = ".bincomp[name='" + component.type + "']";
            //$("#sidebar").append("<p>" + selector + "</p>");
            var select = $(selector);
            var option = opt.clone()
                    .attr("value", component.name)
                    .text(component.name);
            // set it selected if theres a cookie                    
            if (!optdict[component.type]) {
                var previous = $.cookie(component.type);
                if (previous && previous == component.name) {
                    optdict[component.type] = component.name;
                } else {
                    optdict[component.type] = component.name;
                }
            }

            select.append(option);
            //alert(select.html());                
        });

        // make sure each component choice has a selected option and
        // set their INITIAL parameter values
        $.each(optdict, function(key, value) {
            buildComponentParams(key, value);
        });

    });



    // rebuild the param lists when we change component
    $(".bincomp").change(function(e) {
            buildComponentParams($(this).attr("name"), $(this).val());
    });
}




</script>

<div id="sidebar">
    <form id="uploadform" name="convertoptions" action="/ocr/binarize" method="POST" enctype="multipart/form-data">
        <!--        <input type="hidden" name="nohang" value="1" /> -->
        <h4>Choose an Image:</h4>
        <p>    
            <input type="file" name="upload0" id="singleupload" />
        </p>
        <h4>...or Drag-Drop Images Here:</h4>
        <div id="dropzone">
            Drop images here...
        </div>

        <p>
            <input type="button" id="togglesrc" value="Toggle Source/Binary" />
        </p>

        <h4>Options:</h4>

        <div id="options">
            <div class="binparams">
                <select class="bincomp" id="preprocess" name="Preprocess">
                </select>
                <div class="component_opts" id="Preprocess_opts"></div>
            </div>
            <div class="binparams">
                <select class="bincomp" id="binarizer" name="IBinarize">
                </select>
                <div class="component_opts" id="IBinarize_opts"></div>
            </div>
            <div class="binparams">
                <select class="bincomp" id="deskew" name="ICleanupBinary">
                </select>
                <div class="component_opts" id="ICleanupBinary_opts"></div>                 
            </div>
            <div class="binparams">
                <select class="bincomp" id="cleanupgray" name="ICleanupGray">
                </select>
                <div class="component_opts" id="ICleanupGray_opts"></div>                 
            </div>
        </div>
    </form>
</div>

<div id="pageout">
</div>
<div style="clear: right;"></div>
 
{% endblock %}

